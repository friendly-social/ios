name: CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 20
    
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.2
        bundler-cache: true
    
    - name: Install Mise and Tuist
      uses: jdx/mise-action@v2
      with:
        install: false
        
    - name: Install Tuist
      run: |
        mise use -g tuist@latest
        tuist version
    
    - name: Install dependencies
      run: |
        tuist install
    
    - name: Generate project
      run: |
        tuist generate
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install certificates and provisioning profiles
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      env:
        CERTIFICATE_BASE64: ${{ secrets.CERTIFICATE_BASE64 }}
        CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # Create temporary keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
        security set-keychain-settings -t 3600 -u build.keychain
        
        # Install certificate
        echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12
        security import certificate.p12 -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
        
        # Install provisioning profile
        echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > profile.mobileprovision
        bundle exec fastlane run install_provisioning_profile path:"profile.mobileprovision"
    
    - name: Build and upload to TestFlight
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      env:
        APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
        APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_KEY_CONTENT_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_CONTENT_BASE64 }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        bundle exec fastlane beta
    
    - name: Build only (test mode)
      if: (github.ref != 'refs/heads/main' || github.event_name == 'pull_request') && github.event_name != 'workflow_dispatch'
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        tuist install
        tuist generate
        xcodebuild -workspace Friendly.xcworkspace -scheme Friendly -configuration Release -destination 'generic/platform=iOS' clean build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
