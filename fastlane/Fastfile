default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    # Install Tuist dependencies
    sh("cd .. && tuist install")
    # Generate project
    sh("cd .. && tuist generate")
    # Parse provisioning profile to get Name and UUID
    profile_path = File.expand_path("../profile.mobileprovision")
    profile = FastlaneCore::ProvisioningProfile.parse(profile_path)
    profile_name = profile["Name"]
    profile_uuid = profile["UUID"]
    
    # Configure Code Signing specifically for the App target
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "Friendly.xcodeproj",
      targets: ["Friendly"],
      profile_name: profile_name,
      profile_uuid: profile_uuid,
      team_id: ENV["APPLE_TEAM_ID"],
      code_sign_identity: "Apple Distribution",
      build_configurations: ["Release"]
    )

    # Build the app
    build_app(
      workspace: "Friendly.xcworkspace",
      scheme: "Friendly",
      export_method: "app-store",
      xcargs: "CURRENT_PROJECT_VERSION='#{ENV['GITHUB_RUN_NUMBER']}'",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "me.y9san9.Friendly" => profile_name
        }
      }
    )

    # Auth with API Key
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY_CONTENT_BASE64"],
      is_key_content_base64: true,
      in_house: false
    )

    # Upload to TestFlight and distribute to testers
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: false, # Must wait for processing to distribute
      distribute_external: true, # Distribute to external testers
      notify_external_testers: true,
      changelog: "Bug fixes and performance improvements" # Required for external testing
      # If you have specific groups, uncomment and list them:
      # groups: ["Public Testers", "Beta Testers"] 
    )
  end
end
