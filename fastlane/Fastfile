default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    # Install Tuist dependencies
    sh("cd .. && tuist install")
    # Generate project
    sh("cd .. && tuist generate")
    # Build and upload to TestFlight
    build_app(
      workspace: "Friendly.xcworkspace",
      scheme: "Friendly",
      export_method: "app-store",
      xcargs: "CODE_SIGN_STYLE=Manual DEVELOPMENT_TEAM='#{ENV['APPLE_TEAM_ID']}' PROVISIONING_PROFILE_SPECIFIER='Friendly App Store' CODE_SIGN_IDENTITY='Apple Distribution' CURRENT_PROJECT_VERSION='#{ENV['GITHUB_RUN_NUMBER']}'",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "me.y9san9.Friendly" => "Friendly App Store"
        }
      }
    )
    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )
  end
end
