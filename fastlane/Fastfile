default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    # Install Tuist dependencies
    sh("cd .. && tuist install")
    
    # Generate project
    sh("cd .. && tuist generate")

    # Auth with API Key
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY_CONTENT_BASE64"],
      is_key_content_base64: true,
      in_house: false
    )

    # Get latest build number from TestFlight + 1
    current_build_number = latest_testflight_build_number(
      api_key: api_key,
      initial_build_number: 0
    )
    new_build_number = current_build_number + 1
    puts "Building version: #{new_build_number}"

    # Parse provisioning profile
    require 'fastlane_core'
    profile_path = File.expand_path("../profile.mobileprovision")
    profile = FastlaneCore::ProvisioningProfile.parse(profile_path)
    
    # Configure Code Signing
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "Friendly.xcodeproj",
      targets: ["Friendly"],
      profile_name: profile["Name"],
      profile_uuid: profile["UUID"],
      team_id: ENV["APPLE_TEAM_ID"],
      code_sign_identity: "Apple Distribution",
      build_configurations: ["Release"]
    )

    # Build the app
    build_app(
      workspace: "Friendly.xcworkspace",
      scheme: "Friendly",
      export_method: "app-store",
      xcargs: "CURRENT_PROJECT_VERSION='#{new_build_number}'",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "me.y9san9.Friendly" => profile["Name"]
        }
      }
    )

    # Generate changelog
    changelog_text = changelog_from_git_commits(
      commits_count: 10,
      merge_commit_filtering: "exclude_merges",
      pretty: "- %s"
    )

    # Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: false,
      distribute_external: true,
      notify_external_testers: true,
      changelog: changelog_text,
      groups: ["External Group"],
      reject_build_waiting_for_review: true
    )
  end
end
